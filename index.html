<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>记录页面</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <!-- 引入 highlight.js 的 CSS 文件 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#007BFF',
                        secondary: '#6c757d',
                        success: '#28a745',
                        danger: '#dc3545',
                        warning: '#ffc107',
                        info: '#17a2b8',
                        light: '#f8f9fa',
                        dark: '#343a40',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-thin {
                scrollbar-width: thin;
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 5px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background-color: rgba(156, 163, 175, 0.5);
                border-radius: 9999px;
            }
            .fade-in {
                animation: fadeIn 0.3s ease forwards;
            }
            .fade-out {
                animation: fadeOut 0.3s ease forwards;
            }
            .scale-hover {
                transition: transform 0.2s ease;
            }
            .scale-hover:hover {
                transform: scale(1.03);
            }
            .image-loading {
                position: relative;
                overflow: hidden;
            }
            .image-loading::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
                animation: loading 1.5s infinite;
            }
            @keyframes loading {
                100% {
                    left: 100%;
                }
            }
            .markdown-toolbar {
                transition: all 0.3s ease;
            }
            .toolbar-button {
                @apply flex items-center justify-center p-2 rounded hover:bg-gray-100 transition-colors text-gray-700;
            }
            .toolbar-button.active {
                @apply bg-primary/10 text-primary;
            }
            .toolbar-dropdown {
                @apply absolute left-0 top-full bg-white rounded shadow-lg mt-1 z-10 w-48 hidden;
            }
            .toolbar-dropdown-item {
                @apply px-3 py-2 hover:bg-gray-100 cursor-pointer;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-semibold text-primary flex items-center">
                <i class="fa fa-book mr-2"></i>
                <span>记录页面</span>
            </h1>
            <div class="flex items-center space-x-2">
                <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="fa fa-moon-o"></i>
                </button>
                <button id="helpButton" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="fa fa-question-circle"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <!-- 输入区域 -->
        <div class="mb-8">
            <!-- Markdown 工具栏 -->
            <div id="markdownToolbar" class="markdown-toolbar bg-white rounded-t-xl shadow-sm border border-gray-200 border-b-0 opacity-0 translate-y-[-10px] transition-all duration-300">
                <div class="flex flex-wrap items-center py-1 px-2">
                    <!-- 标题选择器 -->
                    <div class="relative group">
                        <button class="toolbar-button" id="headingDropdownButton">
                            <i class="fa fa-header"></i>
                        </button>
                        <div id="headingDropdown" class="toolbar-dropdown">
                            <div class="toolbar-dropdown-item" data-command="heading" data-value="1">标题 1</div>
                            <div class="toolbar-dropdown-item" data-command="heading" data-value="2">标题 2</div>
                            <div class="toolbar-dropdown-item" data-command="heading" data-value="3">标题 3</div>
                            <div class="toolbar-dropdown-item" data-command="heading" data-value="4">标题 4</div>
                            <div class="toolbar-dropdown-item" data-command="heading" data-value="5">标题 5</div>
                            <div class="toolbar-dropdown-item" data-command="heading" data-value="6">标题 6</div>
                        </div>
                    </div>
                    
                    <div class="h-6 w-px bg-gray-200 mx-1"></div>
                    
                    <!-- 格式按钮 -->
                    <button class="toolbar-button" data-command="bold">
                        <i class="fa fa-bold"></i>
                    </button>
                    <button class="toolbar-button" data-command="italic">
                        <i class="fa fa-italic"></i>
                    </button>
                    <button class="toolbar-button" data-command="strikethrough">
                        <i class="fa fa-strikethrough"></i>
                    </button>
                    <button class="toolbar-button" data-command="blockquote">
                        <i class="fa fa-quote-left"></i>
                    </button>
                    
                    <div class="h-6 w-px bg-gray-200 mx-1"></div>
                    
                    <!-- 列表按钮 -->
                    <button class="toolbar-button" data-command="ul">
                        <i class="fa fa-list-ul"></i>
                    </button>
                    <button class="toolbar-button" data-command="ol">
                        <i class="fa fa-list-ol"></i>
                    </button>
                    <button class="toolbar-button" data-command="task">
                        <i class="fa fa-check-square-o"></i>
                    </button>
                    
                    <div class="h-6 w-px bg-gray-200 mx-1"></div>
                    
                    <!-- 其他元素 -->
                    <button class="toolbar-button" data-command="link">
                        <i class="fa fa-link"></i>
                    </button>
                    <button class="toolbar-button" data-command="image">
                        <i class="fa fa-image"></i>
                    </button>
                    <button class="toolbar-button" data-command="code">
                        <i class="fa fa-code"></i>
                    </button>
                    <button class="toolbar-button" data-command="table">
                        <i class="fa fa-table"></i>
                    </button>
                    
                    <div class="h-6 w-px bg-gray-200 mx-1"></div>
                    
                    <!-- 对齐方式 -->
                    <div class="ml-auto">
                        <button class="toolbar-button" data-command="align-left">
                            <i class="fa fa-align-left"></i>
                        </button>
                        <button class="toolbar-button" data-command="align-center">
                            <i class="fa fa-align-center"></i>
                        </button>
                        <button class="toolbar-button" data-command="align-right">
                            <i class="fa fa-align-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 编辑器 -->
            <div class="bg-white rounded-b-xl shadow-sm p-4 border border-gray-200 mb-4">
                <div id="inputText" contenteditable="true" placeholder="在这里粘贴或输入你的 Markdown 记录内容" 
                    class="min-h-[200px] w-full outline-none focus:ring-2 focus:ring-primary/30 transition-all"></div>
            </div>
            
            <!-- 按钮组 - 移动视图优化 -->
            <div class="flex flex-wrap gap-3">
                <button id="saveButton" onclick="saveRecord()" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all shadow-sm hover:shadow flex items-center justify-center">
                    <i class="fa fa-save mr-2"></i> 保存记录
                </button>
                <button id="updateButton" onclick="updateRecord()" class="flex-1 bg-info hover:bg-info/90 text-white font-medium py-2 px-4 rounded-lg transition-all shadow-sm hover:shadow flex items-center justify-center hidden">
                    <i class="fa fa-refresh mr-2"></i> 保存修改
                </button>
                <button id="cancelEditButton" onclick="cancelEdit()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all shadow-sm hover:shadow flex items-center justify-center hidden">
                    <i class="fa fa-times mr-2"></i> 取消编辑
                </button>
                <button class="delete flex-1 bg-danger hover:bg-danger/90 text-white font-medium py-2 px-4 rounded-lg transition-all shadow-sm hover:shadow flex items-center justify-center" onclick="deleteSelectedRecords()">
                    <i class="fa fa-trash mr-2"></i> 删除选中
                </button>
                <button onclick="selectAllRecords()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all shadow-sm hover:shadow flex items-center justify-center">
                    <i class="fa fa-check-square mr-2"></i> 全选
                </button>
            </div>
        </div>

        <!-- 记录列表区域 -->
        <div>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">已保存的记录</h2>
                <div class="text-sm text-gray-500" id="recordCount">0 条记录</div>
            </div>
            
            <!-- 记录列表容器 -->
            <div id="recordListContainer" class="max-h-[calc(100vh-350px)] overflow-y-auto scrollbar-thin">
                <ul id="recordList" class="space-y-3"></ul>
                
                <!-- 空状态 -->
                <div id="emptyState" class="py-12 flex flex-col items-center justify-center text-center">
                    <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                        <i class="fa fa-file-text-o text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-500 mb-2">暂无记录</h3>
                    <p class="text-gray-400 text-sm">保存你的第一条记录以开始使用</p>
                </div>
            </div>
        </div>
    </main>

    <!-- 大图查看遮罩层 -->
    <div class="overlay fixed inset-0 bg-black/70 z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300" id="overlay">
        <div class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <button onclick="closeFullSize()" class="absolute top-3 right-3 bg-black/30 hover:bg-black/50 text-white rounded-full p-2 transition-colors z-10">
                <i class="fa fa-times"></i>
            </button>
            <div class="flex items-center justify-center h-full p-4">
                <img id="fullSizeImage" class="max-w-full max-h-[calc(90vh-2rem)] object-contain" src="" alt="放大的图片">
            </div>
        </div>
    </div>

    <!-- 帮助模态框 -->
    <div id="helpModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 transform transition-transform duration-300 scale-95" id="modalContent">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">使用帮助</h3>
                    <button onclick="closeHelpModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="space-y-4 text-sm text-gray-600">
                    <div>
                        <h4 class="font-medium text-gray-800 mb-1">如何保存记录？</h4>
                        <p>在上方编辑器中输入或粘贴内容，然后点击"保存记录"按钮。</p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-800 mb-1">如何编辑记录？</h4>
                        <p>点击记录右侧的"编辑"按钮，在上方编辑器中修改内容后点击"保存修改"。</p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-800 mb-1">如何删除记录？</h4>
                        <p>点击记录前的复选框选择记录，然后点击"删除选中"按钮。</p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-800 mb-1">如何插入图片？</h4>
                        <p>直接从剪贴板粘贴图片，或使用拖放功能添加图片。</p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-800 mb-1">支持Markdown吗？</h4>
                        <p>是的，记录内容支持Markdown语法，并会自动渲染为格式化文本。</p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-800 mb-1">Markdown工具有什么用？</h4>
                        <p>当您开始编辑时，顶部会出现Markdown工具栏，您可以使用这些按钮快速添加格式、链接、图片等Markdown元素。</p>
                    </div>
                </div>
            </div>
            <div class="px-6 py-3 bg-gray-50 rounded-b-xl flex justify-end">
                <button onclick="closeHelpModal()" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all">
                    了解了
                </button>
            </div>
        </div>
    </div>

    <!-- 通知提示框 -->
    <div id="notification" class="fixed bottom-4 right-4 bg-white shadow-lg rounded-lg p-4 max-w-sm transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center">
        <div id="notificationIcon" class="mr-3 text-lg">
            <i class="fa fa-info-circle"></i>
        </div>
        <div class="flex-grow">
            <h4 id="notificationTitle" class="font-medium text-gray-800">通知标题</h4>
            <p id="notificationMessage" class="text-sm text-gray-600">通知内容</p>
        </div>
        <button onclick="hideNotification()" class="text-gray-400 hover:text-gray-600">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>© 2025 记录页面 - 轻松保存和管理你的笔记</p>
        </div>
    </footer>

    <!-- 引入 marked 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
    <!-- 引入 highlight.js 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        // 初始化 marked 库
        marked.setOptions({
            highlight: function (code, lang) {
                const language = highlight.js.getLanguage(lang) ? lang : 'plaintext';
                return highlight.js.highlight(code, { language }).value;
            }
        });

        // 初始化 BroadcastChannel
        const channel = new BroadcastChannel('record-sync');
        
        // 当前正在编辑的记录索引
        let editingRecordIndex = null;
        // 编辑器聚焦状态
        let editorFocused = false;
        // 工具栏可见状态
        let toolbarVisible = false;
        // 通知定时器
        let notificationTimer = null;

        // 页面加载时从 localStorage 读取记录
        window.onload = function () {
            try {
                const records = JSON.parse(localStorage.getItem('records')) || [];
                renderRecords(records);
                updateRecordCount(records.length);
                
                // 初始化帮助按钮
                document.getElementById('helpButton').addEventListener('click', openHelpModal);
                
                // 初始化主题切换
                document.getElementById('themeToggle').addEventListener('click', toggleTheme);
                
                // 检查并应用保存的主题
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('themeToggle').innerHTML = '<i class="fa fa-sun-o"></i>';
                }
                
                // 初始化 Markdown 工具栏
                initMarkdownToolbar();
                
                // 监听编辑器聚焦和失焦事件
                const inputText = document.getElementById('inputText');
                inputText.addEventListener('focus', function() {
                    editorFocused = true;
                    showMarkdownToolbar();
                });
                
                inputText.addEventListener('blur', function() {
                    editorFocused = false;
                    // 延迟隐藏工具栏，给用户点击工具栏按钮的时间
                    setTimeout(function() {
                        if (!editorFocused && !toolbarHasFocus()) {
                            hideMarkdownToolbar();
                        }
                    }, 300);
                });
                
                // 监听工具栏按钮点击
                document.querySelectorAll('#markdownToolbar [data-command]').forEach(button => {
                    button.addEventListener('click', function() {
                        const command = this.getAttribute('data-command');
                        const value = this.getAttribute('data-value');
                        executeMarkdownCommand(command, value);
                        
                        // 防止按钮点击导致编辑器失焦
                        inputText.focus();
                    });
                });
                
                // 监听标题下拉菜单
                document.getElementById('headingDropdownButton').addEventListener('click', function(e) {
                    e.stopPropagation(); // 防止事件冒泡到 document
                    const dropdown = document.getElementById('headingDropdown');
                    dropdown.classList.toggle('hidden');
                });
                
                // 点击其他区域关闭下拉菜单
                document.addEventListener('click', function(event) {
                    const dropdown = document.getElementById('headingDropdown');
                    if (!dropdown.contains(event.target) && 
                        event.target.id !== 'headingDropdownButton') {
                        dropdown.classList.add('hidden');
                    }
                });
                
                // 监听标题下拉菜单项点击
                document.querySelectorAll('#headingDropdown .toolbar-dropdown-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const command = this.getAttribute('data-command');
                        const value = this.getAttribute('data-value');
                        executeMarkdownCommand(command, value);
                        document.getElementById('headingDropdown').classList.add('hidden');
                        
                        // 防止菜单项点击导致编辑器失焦
                        inputText.focus();
                    });
                });
                
                // 监听工具栏的鼠标进入和离开事件
                const toolbar = document.getElementById('markdownToolbar');
                toolbar.addEventListener('mouseenter', function() {
                    if (!editorFocused) {
                        // 如果编辑器没有焦点，但鼠标在工具栏上，保持工具栏可见
                        clearTimeout(window.hideToolbarTimeout);
                    }
                });
                
                toolbar.addEventListener('mouseleave', function() {
                    if (!editorFocused) {
                        // 如果编辑器没有焦点，且鼠标离开工具栏，延迟隐藏工具栏
                        window.hideToolbarTimeout = setTimeout(function() {
                            if (!editorFocused && !toolbarHasFocus()) {
                                hideMarkdownToolbar();
                            }
                        }, 300);
                    }
                });
                
                // 监听粘贴事件
                inputText.addEventListener('paste', async function (e) {
                    const items = e.clipboardData.items;
                    let foundImage = false;
                    
                    for (let i = 0; i < items.length; i++) {
                        const item = items[i];
                        if (item.type.indexOf('image')!== -1) {
                            e.preventDefault(); // 阻止默认粘贴行为
                            foundImage = true;
                            
                            try {
                                // 获取文件对象
                                const blob = await new Promise((resolve, reject) => {
                                    const file = item.getAsFile();
                                    if (file) {
                                        resolve(file);
                                    } else {
                                        reject(new Error('无法获取文件对象'));
                                    }
                                });
                                
                                // 读取文件内容
                                const reader = new FileReader();
                                reader.onload = function (event) {
                                    const originalDataURL = event.target.result;
                                    
                                    // 创建不同尺寸的缩略图（根据屏幕尺寸）
                                    const isMobile = window.innerWidth < 768;
                                    const maxWidth = isMobile ? 400 : 800;
                                    const maxHeight = isMobile ? 300 : 600;
                                    
                                    createThumbnail(originalDataURL, maxWidth, maxHeight, function(thumbnailDataURL) {
                                        insertImageIntoEditor(thumbnailDataURL, originalDataURL);
                                    });
                                };
                                
                                reader.onerror = function (error) {
                                    console.error('读取文件时出错:', error);
                                    showNotification('插入图片失败', 'error');
                                };
                                
                                reader.readAsDataURL(blob);
                            } catch (error) {
                                console.error('处理粘贴图片时出错:', error);
                                showNotification('插入图片失败', 'error');
                            }
                            
                            break;
                        }
                    }
                    
                    // 如果没有找到图片，允许默认粘贴行为
                    if (!foundImage) {
                        // 处理文本粘贴
                        setTimeout(function() {
                            // 确保内容更新后执行
                            formatPastedContent(inputText);
                        }, 0);
                    }
                });
                
                // 监听广播消息，实现多标签页同步
                channel.onmessage = function(event) {
                    if (event.data.action === 'recordsUpdated') {
                        const records = JSON.parse(localStorage.getItem('records')) || [];
                        renderRecords(records);
                        updateRecordCount(records.length);
                    }
                };
            } catch (error) {
                console.error('读取 localStorage 记录时出错:', error);
                showNotification('加载记录失败', 'error');
            }
        };

        // 格式化粘贴的内容
        function formatPastedContent(element) {
            // 简单的格式化处理，可以根据需要扩展
            const content = element.innerHTML;
            // 例如：移除多余的空行
            element.innerHTML = content.replace(/<p><br><\/p>/g, '<p><br/></p>');
        }

        // 检查工具栏是否有焦点
        function toolbarHasFocus() {
            const toolbar = document.getElementById('markdownToolbar');
            return toolbar.contains(document.activeElement);
        }

        // 初始化 Markdown 工具栏
        function initMarkdownToolbar() {
            const toolbar = document.getElementById('markdownToolbar');
            // 初始隐藏工具栏
            toolbar.classList.add('opacity-0', 'translate-y-[-10px]');
        }

        // 显示 Markdown 工具栏
        function showMarkdownToolbar() {
            const toolbar = document.getElementById('markdownToolbar');
            toolbar.classList.remove('hidden');
            setTimeout(() => {
                toolbar.classList.remove('opacity-0', 'translate-y-[-10px]');
                toolbarVisible = true;
            }, 10);
        }

        // 隐藏 Markdown 工具栏
        function hideMarkdownToolbar() {
            const toolbar = document.getElementById('markdownToolbar');
            toolbar.classList.add('opacity-0', 'translate-y-[-10px]');
            setTimeout(() => {
                toolbar.classList.add('hidden');
                toolbarVisible = false;
            }, 300);
        }

        // 执行 Markdown 命令
        function executeMarkdownCommand(command, value) {
            const inputText = document.getElementById('inputText');
            const selection = window.getSelection();
            
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            let selectedText = selection.toString();
            let replacement = '';
            
            switch(command) {
                case 'heading':
                    const level = parseInt(value);
                    const prefix = '#'.repeat(level) + ' ';
                    if (selectedText) {
                        // 处理选中的多行文本
                        const lines = selectedText.split('\n');
                        replacement = lines.map(line => prefix + line).join('\n');
                    } else {
                        replacement = prefix + '标题 ' + level;
                        // 选中标题文本以便用户直接修改
                        range.setStart(range.startContainer, range.startOffset + prefix.length);
                        range.setEnd(range.startContainer, range.startOffset + ('标题 ' + level).length);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                    break;
                    
                case 'bold':
                    replacement = `**${selectedText || '粗体文本'}**`;
                    break;
                    
                case 'italic':
                    replacement = `*${selectedText || '斜体文本'}*`;
                    break;
                    
                case 'strikethrough':
                    replacement = `~~${selectedText || '删除线文本'}~~`;
                    break;
                    
                case 'blockquote':
                    if (selectedText) {
                        const lines = selectedText.split('\n');
                        replacement = lines.map(line => '> ' + line).join('\n');
                    } else {
                        replacement = '> 引用文本';
                    }
                    break;
                    
                case 'ul':
                    if (selectedText) {
                        const lines = selectedText.split('\n');
                        replacement = lines.map(line => '- ' + line).join('\n');
                    } else {
                        replacement = '- 无序列表项\n- 无序列表项\n- 无序列表项';
                        // 选中第二个列表项以便用户直接修改
                        range.setStart(range.startContainer, range.startOffset + 11);
                        range.setEnd(range.startContainer, range.startOffset + 22);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                    break;
                    
                case 'ol':
                    if (selectedText) {
                        const lines = selectedText.split('\n');
                        replacement = lines.map((line, index) => `${index + 1}. ${line}`).join('\n');
                    } else {
                        replacement = '1. 有序列表项\n2. 有序列表项\n3. 有序列表项';
                        // 选中第二个列表项以便用户直接修改
                        range.setStart(range.startContainer, range.startOffset + 11);
                        range.setEnd(range.startContainer, range.startOffset + 22);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                    break;
                    
                case 'task':
                    if (selectedText) {
                        const lines = selectedText.split('\n');
                        replacement = lines.map(line => '- [ ] ' + line).join('\n');
                    } else {
                        replacement = '- [ ] 待办事项\n- [ ] 待办事项\n- [x] 已完成事项';
                        // 选中第二个待办事项以便用户直接修改
                        range.setStart(range.startContainer, range.startOffset + 12);
                        range.setEnd(range.startContainer, range.startOffset + 23);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                    break;
                    
                case 'link':
                    const linkText = selectedText || '链接文本';
                    replacement = `[${linkText}](https://example.com)`;
                    // 选中 URL 以便用户直接修改
                    if (!selectedText) {
                        range.setStart(range.startContainer, range.startOffset + linkText.length + 2);
                        range.setEnd(range.startContainer, range.startOffset + 23);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                    break;
                    
                case 'image':
                    replacement = '![图片描述](https://picsum.photos/800/400)';
                    // 选中图片描述以便用户直接修改
                    range.setStart(range.startContainer, range.startOffset + 2);
                    range.setEnd(range.startContainer, range.startOffset + 6);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    break;
                    
                case 'code':
                    if (selectedText.includes('\n')) {
                        replacement = "```javascript\n" + selectedText + "\n```";
                    } else {
                        replacement = `\`${selectedText || '代码'}\``;
                    }
                    break;
                    
                case 'table':
                    replacement = `| 表头1 | 表头2 | 表头3 |\n| --- | --- | --- |\n| 单元格1 | 单元格2 | 单元格3 |\n| 单元格4 | 单元格5 | 单元格6 |`;
                    // 选中第一行数据以便用户直接修改
                    range.setStart(range.startContainer, range.startOffset + 21);
                    range.setEnd(range.startContainer, range.startOffset + 32);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    break;
                    
                case 'align-left':
                    // 简单实现，实际中可能需要更复杂的处理
                    replacement = `<div style="text-align: left;">${selectedText || '左对齐文本'}</div>`;
                    break;
                    
                case 'align-center':
                    replacement = `<div style="text-align: center;">${selectedText || '居中对齐文本'}</div>`;
                    break;
                    
                case 'align-right':
                    replacement = `<div style="text-align: right;">${selectedText || '右对齐文本'}</div>`;
                    break;
            }
            
            // 替换选中文本
            if (replacement) {
                range.deleteContents();
                const textNode = document.createTextNode(replacement);
                range.insertNode(textNode);
                
                // 调整光标位置
                if (!selectedText) {
                    const pos = replacement.indexOf('文本');
                    if (pos !== -1) {
                        range.setStart(textNode, pos);
                        range.setEnd(textNode, pos + 2);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }
            }
            
            // 触发输入事件以便更新预览
            const event = new Event('input', { bubbles: true });
            inputText.dispatchEvent(event);
        }

        // 创建图片缩略图
        function createThumbnail(originalDataURL, maxWidth, maxHeight, callback) {
            const img = new Image();
            img.src = originalDataURL;
            
            img.onload = function() {
                let width = img.width;
                let height = img.height;
                
                // 计算缩放比例
                if (width > maxWidth) {
                    height = height * (maxWidth / width);
                    width = maxWidth;
                }
                
                if (height > maxHeight) {
                    width = width * (maxHeight / height);
                    height = maxHeight;
                }
                
                // 创建画布并绘制图片
                const canvas = new OffscreenCanvas(width, height);
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // 转换为DataURL
                canvas.convertToBlob().then(blob => {
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        callback(reader.result);
                    };
                    reader.readAsDataURL(blob);
                });
            };
        }

        // 插入图片到编辑器
        function insertImageIntoEditor(thumbnailDataURL, originalDataURL) {
            const inputText = document.getElementById('inputText');
            const selection = window.getSelection();
            
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            const imageAlt = '图片';
            
            // 构建 Markdown 图片语法，使用缩略图显示，但保存原始图片
            const imageMarkdown = `![${imageAlt}](${thumbnailDataURL})`;
            
            // 替换选中文本
            range.deleteContents();
            const textNode = document.createTextNode(imageMarkdown);
            range.insertNode(textNode);
            
            // 触发输入事件
            const event = new Event('input', { bubbles: true });
            inputText.dispatchEvent(event);
            
            showNotification('图片已插入', 'success');
        }

        // 保存记录
        function saveRecord() {
            const content = document.getElementById('inputText').innerHTML.trim();
            
            if (!content) {
                showNotification('记录内容不能为空', 'warning');
                return;
            }
            
            try {
                const records = JSON.parse(localStorage.getItem('records')) || [];
                const now = new Date();
                const formattedTime = formatDateTime(now);
                
                const newRecord = {
                    content: content,
                    time: formattedTime,
                    id: Date.now().toString() // 为每条记录生成唯一ID
                };
                
                records.push(newRecord);
                localStorage.setItem('records', JSON.stringify(records));
                
                // 通知其他标签页
                channel.postMessage({ action: 'recordsUpdated' });
                
                // 更新UI
                renderRecords(records);
                updateRecordCount(records.length);
                document.getElementById('inputText').innerHTML = '';
                
                showNotification('记录已保存', 'success');
            } catch (error) {
                console.error('保存记录时出错:', error);
                showNotification('保存记录失败', 'error');
            }
        }

        // 更新记录
        function updateRecord() {
            if (editingRecordIndex === null) return;
            
            const content = document.getElementById('inputText').innerHTML.trim();
            
            if (!content) {
                showNotification('记录内容不能为空', 'warning');
                return;
            }
            
            try {
                const records = JSON.parse(localStorage.getItem('records')) || [];
                
                if (editingRecordIndex >= 0 && editingRecordIndex < records.length) {
                    const now = new Date();
                    const formattedTime = formatDateTime(now);
                    
                    // 保存修改时间
                    records[editingRecordIndex].content = content;
                    records[editingRecordIndex].modifiedTime = formattedTime;
                    
                    localStorage.setItem('records', JSON.stringify(records));
                    
                    // 通知其他标签页
                    channel.postMessage({ action: 'recordsUpdated' });
                    
                    // 更新UI
                    renderRecords(records);
                    cancelEdit();
                    
                    showNotification('记录已更新', 'success');
                } else {
                    showNotification('找不到要编辑的记录', 'error');
                }
            } catch (error) {
                console.error('更新记录时出错:', error);
                showNotification('更新记录失败', 'error');
            }
        }

        // 开始编辑记录
        function startEditing(index) {
            try {
                const records = JSON.parse(localStorage.getItem('records')) || [];
                
                if (index >= 0 && index < records.length) {
                    editingRecordIndex = index;
                    const record = records[index];
                    
                    // 填充编辑器
                    document.getElementById('inputText').innerHTML = record.content;
                    
                    // 切换按钮状态
                    document.getElementById('saveButton').classList.add('hidden');
                    document.getElementById('updateButton').classList.remove('hidden');
                    document.getElementById('cancelEditButton').classList.remove('hidden');
                    
                    // 显示并聚焦编辑器
                    document.getElementById('inputText').focus();
                    
                    // 滚动到顶部
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    showNotification('找不到要编辑的记录', 'error');
                }
            } catch (error) {
                console.error('获取记录时出错:', error);
                showNotification('加载记录失败', 'error');
            }
        }

        // 取消编辑
        function cancelEdit() {
            editingRecordIndex = null;
            document.getElementById('inputText').innerHTML = '';
            document.getElementById('saveButton').classList.remove('hidden');
            document.getElementById('updateButton').classList.add('hidden');
            document.getElementById('cancelEditButton').classList.add('hidden');
        }

        // 删除选中的记录
        function deleteSelectedRecords() {
            const checkboxes = document.querySelectorAll('#recordList input[type="checkbox"]');
            const selectedIndices = [];
            
            checkboxes.forEach((checkbox, index) => {
                if (checkbox.checked) {
                    selectedIndices.push(checkboxes.length - 1 - index); // 反转索引，因为记录是倒序显示的
                }
            });
            
            if (selectedIndices.length === 0) {
                showNotification('请先选择要删除的记录', 'warning');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${selectedIndices.length} 条记录吗？此操作不可撤销。`)) {
                try {
                    const records = JSON.parse(localStorage.getItem('records')) || [];
                    
                    // 按降序排列索引，避免删除元素后索引变化
                    selectedIndices.sort((a, b) => b - a);
                    
                    // 删除选中的记录
                    selectedIndices.forEach(index => {
                        if (index >= 0 && index < records.length) {
                            records.splice(index, 1);
                        }
                    });
                    
                    localStorage.setItem('records', JSON.stringify(records));
                    
                    // 通知其他标签页
                    channel.postMessage({ action: 'recordsUpdated' });
                    
                    // 更新UI
                    renderRecords(records);
                    updateRecordCount(records.length);
                    
                    showNotification(`已删除 ${selectedIndices.length} 条记录`, 'success');
                } catch (error) {
                    console.error('删除记录时出错:', error);
                    showNotification('删除记录失败', 'error');
                }
            }
        }

        // 全选/取消全选记录
        function selectAllRecords() {
            const checkboxes = document.querySelectorAll('#recordList input[type="checkbox"]');
            let allChecked = true;
            
            // 检查是否所有复选框都已选中
            checkboxes.forEach(checkbox => {
                if (!checkbox.checked) {
                    allChecked = false;
                }
            });
            
            // 设置所有复选框状态
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }

        // 打开大图查看
        function openFullSize(imgElement) {
            const overlay = document.getElementById('overlay');
            const fullSizeImage = document.getElementById('fullSizeImage');
            
            // 设置大图的源
            fullSizeImage.src = imgElement.src;
            
            // 显示遮罩层
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
            }, 10);
            
            // 防止页面滚动
            document.body.style.overflow = 'hidden';
        }

        // 关闭大图查看
        function closeFullSize() {
            const overlay = document.getElementById('overlay');
            
            // 隐藏遮罩层
            overlay.classList.add('opacity-0');
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 300);
            
            // 恢复页面滚动
            document.body.style.overflow = '';
        }

        // 打开帮助模态框
        function openHelpModal() {
            const modal = document.getElementById('helpModal');
            const modalContent = document.getElementById('modalContent');
            
            // 显示模态框
            modal.classList.remove('opacity-0');
            modal.classList.remove('pointer-events-none');
            setTimeout(() => {
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
            
            // 防止页面滚动
            document.body.style.overflow = 'hidden';
        }

        // 关闭帮助模态框
        function closeHelpModal() {
            const modal = document.getElementById('helpModal');
            const modalContent = document.getElementById('modalContent');
            
            // 隐藏模态框
            modalContent.classList.remove
                        modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('opacity-0');
                modal.classList.add('pointer-events-none');
            }, 300);
            
            // 恢复页面滚动
            document.body.style.overflow = '';
        }

        // 复制内容到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    console.log('内容已复制到剪贴板');
                })
                .catch(err => {
                    console.error('复制失败:', err);
                    // 备用方法
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                });
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            const notificationIcon = document.getElementById('notificationIcon');
            
            // 设置通知内容
            notificationTitle.textContent = getNotificationTitle(type);
            notificationMessage.textContent = message;
            
            // 设置通知图标和颜色
            notificationIcon.innerHTML = getNotificationIcon(type);
            notification.className = `fixed bottom-4 right-4 shadow-lg rounded-lg p-4 max-w-sm transform transition-all duration-300 z-50 flex items-center ${getNotificationClass(type)}`;
            
            // 显示通知
            notification.classList.remove('translate-y-20', 'opacity-0');
            
            // 清除之前的定时器
            if (notificationTimer) {
                clearTimeout(notificationTimer);
            }
            
            // 设置自动隐藏
            notificationTimer = setTimeout(() => {
                hideNotification();
            }, 3000);
        }

        // 隐藏通知
        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.add('translate-y-20', 'opacity-0');
        }

        // 获取通知标题
        function getNotificationTitle(type) {
            switch(type) {
                case 'success':
                    return '成功';
                case 'error':
                    return '错误';
                case 'warning':
                    return '警告';
                default:
                    return '通知';
            }
        }

        // 获取通知图标
        function getNotificationIcon(type) {
            switch(type) {
                case 'success':
                    return '<i class="fa fa-check-circle text-success"></i>';
                case 'error':
                    return '<i class="fa fa-times-circle text-danger"></i>';
                case 'warning':
                    return '<i class="fa fa-exclamation-triangle text-warning"></i>';
                default:
                    return '<i class="fa fa-info-circle text-info"></i>';
            }
        }

        // 获取通知样式类
        function getNotificationClass(type) {
            switch(type) {
                case 'success':
                    return 'bg-success/10 border-l-4 border-success';
                case 'error':
                    return 'bg-danger/10 border-l-4 border-danger';
                case 'warning':
                    return 'bg-warning/10 border-l-4 border-warning';
                default:
                    return 'bg-info/10 border-l-4 border-info';
            }
        }

        // 格式化日期时间
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // 更新记录计数
        function updateRecordCount(count) {
            document.getElementById('recordCount').textContent = `${count} 条记录`;
        }

        // 切换主题
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                themeToggle.innerHTML = '<i class="fa fa-moon-o"></i>';
            } else {
                body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                themeToggle.innerHTML = '<i class="fa fa-sun-o"></i>';
            }
        }
    </script>
</body>
</html>
